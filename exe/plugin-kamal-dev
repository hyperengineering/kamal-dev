#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"

class KamalDevInstaller
  PATCH_MARKER = 'require "kamal-dev"'
  BINSTUB_PATH = "bin/kamal"

  def initialize
    @patched = false
    @created_binstub = false
    @mode = nil
  end

  def run
    print_header

    unless in_project_directory?
      error "Not in a project directory. Please run this from your project root (must have a Gemfile)."
      exit 1
    end

    # Ask user which installation method they prefer
    choose_installation_mode

    case @mode
    when :gem
      patch_gem_executable
    when :binstub
      ensure_bin_directory
      ensure_kamal_binstub
      patch_binstub
    end

    print_success
  end

  private

  def print_header
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ”§ Kamal Dev Installer"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts
  end

  def choose_installation_mode
    puts "Choose installation method:"
    puts
    puts "  1. Patch gem-installed kamal executable (global, works with 'kamal dev')"
    puts "  2. Create project binstub bin/kamal (local, use 'bin/kamal dev')"
    puts
    print "Enter choice [1/2] (default: 1): "

    choice = $stdin.gets.chomp
    choice = "1" if choice.empty?

    case choice
    when "1"
      @mode = :gem
    when "2"
      @mode = :binstub
    else
      error "Invalid choice. Please enter 1 or 2."
      exit 1
    end

    puts
  end

  def patch_gem_executable
    gem_executable = find_gem_executable

    unless gem_executable
      error "Could not find kamal executable. Make sure 'kamal' gem is installed."
      exit 1
    end

    puts "ğŸ“ Found kamal executable: #{gem_executable}"
    puts

    if already_patched?(File.read(gem_executable))
      puts "âœ“ Kamal executable already patched (kamal-dev is loaded)"
      return
    end

    # Create backup
    backup_path = "#{gem_executable}.backup"
    unless File.exist?(backup_path)
      puts "ğŸ’¾ Creating backup: #{backup_path}"
      FileUtils.cp(gem_executable, backup_path)
    else
      puts "âœ“ Backup already exists: #{backup_path}"
    end

    # Patch the executable
    puts "ğŸ”§ Patching kamal executable..."
    content = File.read(gem_executable)
    patched_content = insert_require(content)

    if patched_content.nil?
      error "Could not find a safe insertion point in kamal executable. Please patch manually."
      exit 1
    end

    File.write(gem_executable, patched_content)
    @patched = true
    puts "âœ“ Patched kamal executable"
  end

  def find_gem_executable
    # Try to find via bundle
    kamal_path = `bundle exec which kamal 2>/dev/null`.strip
    return kamal_path unless kamal_path.empty?

    # Try via gem
    kamal_path = `which kamal 2>/dev/null`.strip
    return kamal_path unless kamal_path.empty?

    # Try via gem environment
    gem_bin_dir = `gem environment gemdir 2>/dev/null`.strip
    return nil if gem_bin_dir.empty?

    possible_path = File.join(gem_bin_dir.sub("/gems", "/bin"), "kamal")
    return possible_path if File.exist?(possible_path)

    nil
  end

  def in_project_directory?
    File.exist?("Gemfile")
  end

  def ensure_bin_directory
    return if Dir.exist?("bin")

    puts "ğŸ“ Creating bin directory..."
    FileUtils.mkdir_p("bin")
  end

  def ensure_kamal_binstub
    return if File.exist?(BINSTUB_PATH)

    puts "ğŸ“ Generating kamal binstub..."
    unless system("bundle binstubs kamal --force", out: File::NULL, err: File::NULL)
      error "Failed to generate kamal binstub. Make sure 'kamal' gem is in your Gemfile."
      exit 1
    end

    @created_binstub = true

    unless File.exist?(BINSTUB_PATH)
      error "Binstub generation succeeded but #{BINSTUB_PATH} not found. Please check your bundler configuration."
      exit 1
    end

    puts "âœ“ Created #{BINSTUB_PATH}"
  end

  def patch_binstub
    content = File.read(BINSTUB_PATH)

    if already_patched?(content)
      puts "âœ“ #{BINSTUB_PATH} already patched (kamal-dev is loaded)"
      return
    end

    puts "ğŸ”§ Patching #{BINSTUB_PATH}..."

    patched_content = insert_require(content)

    if patched_content.nil?
      error "Could not find a safe insertion point in #{BINSTUB_PATH}. Please add '#{PATCH_MARKER}' manually after bundler setup."
      exit 1
    end

    # Write patched content
    File.write(BINSTUB_PATH, patched_content)

    # Preserve executable permissions
    File.chmod(0755, BINSTUB_PATH)

    @patched = true
    puts "âœ“ Patched #{BINSTUB_PATH}"
  end

  def already_patched?(content)
    content.include?(PATCH_MARKER) || content.include?("require 'kamal-dev'")
  end

  def insert_require(content)
    lines = content.lines

    # Strategy 1: Insert after "require 'bundler/setup'" or similar bundler requires
    bundler_setup_index = lines.find_index { |line| line =~ /require ['"]bundler\/setup['"]/ }

    if bundler_setup_index
      # Insert after bundler setup and any following blank lines
      insert_index = bundler_setup_index + 1
      insert_index += 1 while insert_index < lines.size && lines[insert_index].strip.empty?

      lines.insert(insert_index, "\n# Load kamal-dev extension to enable 'kamal dev' commands\n#{PATCH_MARKER}\n")
      return lines.join
    end

    # Strategy 2: Insert before "load Gem.bin_path" or "Gem.activate_bin_path"
    load_index = lines.find_index { |line| line =~ /(load Gem\.bin_path|Gem\.activate_bin_path)/ }

    if load_index
      # Insert before the load line, with a blank line separator
      lines.insert(load_index, "\n# Load kamal-dev extension to enable 'kamal dev' commands\n#{PATCH_MARKER}\n\n")
      return lines.join
    end

    # Strategy 3: Insert after shebang and frozen_string_literal
    # This is the fallback for binstubs we don't recognize
    insert_index = 0
    insert_index += 1 if lines[0]&.start_with?("#!")
    insert_index += 1 if lines[insert_index]&.include?("frozen_string_literal")
    insert_index += 1 while insert_index < lines.size && lines[insert_index].strip.empty?

    if insert_index < lines.size
      lines.insert(insert_index, "\n# Load kamal-dev extension to enable 'kamal dev' commands\n#{PATCH_MARKER}\n\n")
      return lines.join
    end

    # Could not find a safe insertion point
    nil
  end

  def print_success
    puts
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… Installation complete!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts

    if @created_binstub || @patched
      puts "You can now use the 'kamal dev' commands:"
      puts

      case @mode
      when :gem
        puts "  kamal dev deploy --count 3"
        puts "  kamal dev list"
        puts "  kamal dev stop --all"
        puts "  kamal dev remove --all"
        puts
        puts "Or with bundle exec:"
        puts "  bundle exec kamal dev deploy --count 3"
      when :binstub
        puts "  bin/kamal dev deploy --count 3"
        puts "  bin/kamal dev list"
        puts "  bin/kamal dev stop --all"
        puts "  bin/kamal dev remove --all"
        puts
        puts "For more information, run: bin/kamal dev help"
      end
    else
      puts "No changes were needed - you're already set up!"
      puts

      case @mode
      when :gem
        puts "Use: kamal dev <command>"
      when :binstub
        puts "Use: bin/kamal dev <command>"
      end
    end

    puts
  end

  def error(message)
    puts
    puts "âŒ Error: #{message}"
    puts
  end
end

# Run installer
KamalDevInstaller.new.run
