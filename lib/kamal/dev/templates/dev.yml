# Kamal Dev Configuration
# Deploy and manage development container workspaces to cloud infrastructure

# Service name (used as prefix for container naming)
service: myapp-dev

# Destination image (where to push/deploy) - matches Kamal's usage
# Registry server will be prepended if not included
# Examples:
#   myorg/myapp          → ghcr.io/myorg/myapp (registry prepended)
#   ghcr.io/myorg/myapp  → ghcr.io/myorg/myapp (explicit registry)
image: myorg/myapp

# Build configuration (optional - omit to deploy existing image)
# Option 1: Build from devcontainer.json
build:
  devcontainer: .devcontainer/devcontainer.json

# Option 2: Build from Dockerfile
# build:
#   dockerfile: .devcontainer/Dockerfile
#   context: .devcontainer

# Option 3: Deploy existing image (no build needed)
# Remove the build: section entirely and set image to existing image:
# image: ruby:3.2

# Container registry configuration (for building and pushing custom images)
# Required when using build: section
registry:
  server: ghcr.io                # Registry server (default: ghcr.io - GitHub Container Registry)
                                  # Alternatives: docker.io, your-custom-registry.io
  username: GITHUB_USER           # Environment variable name for registry username
  password: GITHUB_TOKEN          # Environment variable name for registry password/token
                                  # For GHCR: create a Personal Access Token with write:packages scope

# Cloud provider configuration
provider:
  type: upcloud              # Cloud provider (currently: upcloud)
  zone: us-nyc1              # Data center location (upcloud zones: us-nyc1, de-fra1, uk-lon1, etc.)
  plan: 1xCPU-2GB            # VM plan/size (upcloud plans: 1xCPU-1GB, 1xCPU-2GB, 2xCPU-4GB, etc.)
  # storage_template: "01000000-0000-4000-8000-000030220200"  # OS template UUID (optional - defaults to Ubuntu 24.04 LTS)
                                                                     # Ubuntu 24.04 LTS: 01000000-0000-4000-8000-000030240200 (default)
                                                                     # Ubuntu 22.04 LTS: 01000000-0000-4000-8000-000030220200
                                                                     # Find UUIDs in UpCloud control panel under Templates

# Secrets to inject from .kamal/secrets file
# These will be loaded and injected as Base64-encoded environment variables
secrets:
  - UPCLOUD_USERNAME         # Required: UpCloud API username
  - UPCLOUD_PASSWORD         # Required: UpCloud API password
  # Registry credentials (required if using registry.username/password above):
  # - GITHUB_USER            # For GitHub Container Registry (ghcr.io)
  # - GITHUB_TOKEN           # Personal Access Token with write:packages scope
  # - DOCKER_HUB_USERNAME    # For Docker Hub (hub.docker.com)
  # - DOCKER_HUB_TOKEN       # Docker Hub access token
  # Add your application secrets here:
  # - DATABASE_URL
  # - API_KEY

# Path to secrets file (default: .kamal/secrets)
# secrets_file: .kamal/secrets

# SSH configuration
ssh:
  key_path: ~/.ssh/id_rsa.pub  # SSH public key for VM access (default: ~/.ssh/id_rsa.pub)

# Git clone configuration (for DevPod-style remote development)
# When configured, code is cloned from repository on deployment
# Local devcontainer usage (VS Code) is unaffected - uses mounted code
git:
  repository: https://github.com/yourorg/yourrepo.git  # Git repository URL (HTTPS format)
  branch: main                                         # Branch to checkout (default: main)
  workspace_folder: /workspaces/myapp                  # Where to clone code (should match devcontainer workspaceFolder)
  token: GITHUB_TOKEN                                  # Environment variable name containing Personal Access Token (for private repos)
                                                       # Generate token at: https://github.com/settings/tokens
                                                       # Scopes needed: repo (for private repos)
                                                       # Add to .kamal/secrets: export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"

# Default resource limits for containers
defaults:
  cpus: 2                    # CPU limit (cores)
  memory: 4g                 # Memory limit
  memory_swap: 8g            # Swap limit (optional)

# VM and container deployment configuration
vms:
  count: 3                   # Number of workspaces to deploy
  spread: false              # false = colocate containers, true = one container per VM

# Container naming pattern
naming:
  pattern: "{service}-{index}"  # Results in: myapp-dev-1, myapp-dev-2, etc.
